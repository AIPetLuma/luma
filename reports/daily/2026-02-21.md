# 2026-02-21 工作总结

## 今日完成
1. 完成 Linux 运行链路稳定性修复：
   - 修复 `sqflite` 在 Linux/桌面下 `databaseFactory not initialized` 问题，接入 `sqflite_common_ffi` 并在本地数据库初始化时自动切换 FFI 工厂。
   - 修复通知初始化在 Linux 的参数缺失问题，补齐 Linux 初始化配置并增加降级兜底。
   - 修复 `WorkManager` 在 Linux 不支持导致的异常，改为平台识别后跳过初始化。
2. 完成 Firebase/FCM 无配置场景的防崩处理：
   - 修复 `core/no-app`（未初始化 Firebase 时访问 `FirebaseMessaging.instance`）问题。
   - `FcmService` 改为懒加载 + Firebase 不可用自动 no-op。
3. 完成 LLM 接入能力增强（从单一厂商扩展为多提供方）：
   - `LlmClient` 支持 `Anthropic` 与 `OpenAI-Compatible` 双协议。
   - 支持 `LLM_PROVIDER / LLM_BASE_URL / LLM_MODEL / LLM_API_KEY` 组合配置，并兼容旧参数。
   - 增加本地 Ollama 404 自动回退到 `/api/chat` 的兼容路径。
4. 完成聊天错误可见性改造（前端提示）：
   - 新增 API key 无效提示（Snackbar）。
   - 新增 HTTP 错误提示，覆盖所有 `4xx/5xx`，并在前端显示状态码。
5. 完成配置与工程化体验优化：
   - 新增带中文说明与必要性标注的 `dev.example.json` 模板。
   - 新增 `Makefile` 缩写命令：`make fr`（运行）与 `make fb`（构建），支持参数覆盖。
   - 更新 README：补充多提供方配置、稳定推荐方案、配置文件与缩写命令说明。

## 测试与验证结果
1. 定向静态检查通过：
   - `app/lib/data/remote/llm_client.dart`
   - `app/lib/features/chat/chat_controller.dart`
   - `app/lib/features/chat/chat_screen.dart`
   - `app/lib/shared/l10n.dart`
2. Linux 运行验证结果：
   - App 可成功构建并启动，聊天主流程可用。
   - 无 Firebase/Supabase 配置场景可正常降级运行。

## 关键新增/修改文件（今日）
1. 重点修改：
   - `app/lib/data/local/database.dart`
   - `app/lib/core/services/notification_service.dart`
   - `app/lib/core/services/background_service.dart`
   - `app/lib/core/services/fcm_service.dart`
   - `app/lib/data/local/secure_storage.dart`
   - `app/lib/data/remote/llm_client.dart`
   - `app/lib/features/chat/chat_controller.dart`
   - `app/lib/features/chat/chat_screen.dart`
   - `app/lib/shared/l10n.dart`
   - `app/lib/providers/pet_provider.dart`
   - `app/test/integration/app_flow_test.dart`
   - `README.md`
   - `Makefile`
2. 新增/调整配置资产：
   - `dev.example.json`（中文注释模板）
   - `.gitignore`（本地配置忽略规则）

## 当前状态与遗留问题
1. 主仓库与 `docs` 子模块分支均为 `feat/phase-g`，分支约束满足。
2. 已知非阻塞环境问题仍存在：
   - VM Service WebSocket 连接受代理/网络策略影响（调试通道不稳定）。
   - Linux keyring 未解锁导致 `flutter_secure_storage` 读取失败（已有降级，不阻塞主流程）。
   - WSL 图形栈警告（`libEGL/MESA/Gdk`）仍会打印，但不影响核心功能。

## 明日建议
1. 在运行环境中补齐代理白名单（`127.0.0.1`、`::1`）以稳定 VM Service。
2. 补一条集成测试：模拟 `HTTP 401/404/500` 并断言前端提示文案。
3. 继续梳理 Linux keyring 使用策略，降低对系统密钥环的依赖风险。
